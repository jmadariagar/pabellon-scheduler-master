{% extends "dashboard/base.html" %}

{% block title %} Programaci贸n {% endblock title %}

{% block stylesheets %}
{{ block.super}}
<link href="/static/drag.css" rel="stylesheet">
{% endblock %}
{% load get_variable %}
{% block content %}
<main class="main-content bgc-grey-100">
    <div id="mainContent">
        <div class="row gap-20 masonry pos-r">
            <div class="masonry-sizer col-md-6"></div>
            <div class="masonry-item w-100">
                <div class="row gap-20">
                    <!-- #Toatl Visits ==================== -->
                    <div class="bgc-white p-20 bd">
                        <h6 class="c-grey-900">Distribuci贸n de Bloques Extendidos</h6>
                        <div id="redips-drag" class="mT-30">
                            <table class="table table-striped">
                                <thead class="thead-dark">
                                <tr>
                                    <th scope="col" class="redips-only">salas \ dias</th>
                                    {% for d in days %}
                                    <th scope="col" class="redips-only">{{d.day}}</th>
                                    {% endfor %}
                                </tr>
                                </thead>
                                <tbody>
                                {% for r in rooms %}
                                <tr class="table-primary">
                                    <td class="redips-only">Sala {{r.room}} </td>
                                    {% for d in days %}
                                    {% set_global_context 'varaux' '0' %}
                                    {% for s in schedule %}

                                    {% if s.day == d.day and s.room == r.room and s.bloque == 'AM' and s.bloque_extendido == 1%}
                                    {% set_global_context 'varaux' '1' %}
                                    <td>
                                        <div class="redips-drag" >{{ s.especialidad }}</div>
                                    </td>
                                    {% endif %}
                                    {% if varaux == '0' and s.bloque == 'AM' and s.room == r.room and s.day == d.day%}
                                    <td>
                                    </td>
                                    {% endif %}
                                    {% endfor %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <br>
                        <br>
                        <br>
                        <!--<a class="btn btn-primary" href="/programacion/{{id_result}}/lista">Ver Asignaci贸n Lista de Espera Previa</a>-->
                    </div>
                    <form>
                        <div class="col-md-4">
                            <a  href="/programacion/{{id_result}}" class="btn btn-primary" style="width:220px;height:40px;">Volver a la Distribuci贸n</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock content %}

{% block javascripts %}
{{ block.super }}
<script type="text/javascript" src="/static/redips-drag-min.js"></script>
<script >
    window.onload = function() {
      rd = REDIPS.drag;
      rd.init();
      rd.dropMode = 'switch';

      var headertable = [
        {% for d in days %}
         '{{d.day}}',
        {% endfor %}
      ];

      var pos1 = null;
      var pos2 = null;

      rd.event.clicked = function () {
        // get current position (method returns positions as array)
        pos1 = rd.getPosition();
        elem1 = rd.obj;
        // display current row and current cell
        console.log('clicked: ' + pos1[1] + ' ' + pos1[2]);
      };

      rd.event.dropped = function () {
        pos2 = rd.getPosition();
        elem2 = rd.obj;
        console.log('dropped: ' + pos2[1] + ' ' + pos2[2]);

        if(pos1 && pos2){
            if(pos1[1]!==pos2[1] || pos1[2]!==pos2[2]){
              var day1 = headertable[pos1[2]-1];
              console.log('day1: '+ day1)
              var day2 = headertable[pos2[2]-1]
              console.log('day2: '+ day2)
              var room1 = Math.floor(pos1[1]);
              console.log('room1: '+ room1)
              var room2 = Math.floor(pos2[1]);
              console.log('room2: '+ room2)
              updateScheduleExtended(day1, day2, room1, room2);
            }
        }

      };

      function updateScheduleExtended(day1, day2, room1, room2) {

        var http = new XMLHttpRequest();
        var url = "{% url 'update-schedule-extended' %}";
        var data = JSON.stringify({
          'id_result': {{id_result}},
          'day1': day1,
          'day2': day2,
          'room1': room1,
          'room2': room2,
        });
        http.open('POST', url, true);
        http.setRequestHeader('X-CSRFToken','{{ csrf_token }}');
        http.setRequestHeader("Content-type", "application/json");
        http.onreadystatechange = function() {

            if(http.readyState == 4 && http.status == 200) {

              var response = JSON.parse(http.responseText);
              console.log(response);

            }
        };

        http.send(data);
      }
    };
  </script>
{% endblock %}